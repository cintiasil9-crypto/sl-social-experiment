<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üèÜ SL Social Experiment Leaderboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial, sans-serif; background:#f4f6f8; padding:20px; }
h1 { text-align:center; margin-bottom:12px; }

.controls { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px; }

input, select, button {
  padding:7px 10px; font-size:14px;
}
button {
  cursor:pointer; border:none; background:#444; color:#fff; border-radius:4px;
}
button:hover { background:#000; }
button.active { background:#1976d2; }

table { width:100%; border-collapse:collapse; background:#fff; }
th, td {
  border:1px solid #ddd; padding:6px; font-size:13px; white-space:nowrap;
}
th { position:sticky; top:0; background:#fafafa; z-index:3; }

.sticky { position:sticky; background:#fff; z-index:2; }
.sticky.rank { left:0; }
.sticky.check { left:36px; }
.sticky.name { left:76px; }

.meta { background:#e3f2fd; }
.summary { background:#fffde7; white-space:normal; max-width:260px; }
.trait { background:#e8f5e9; }
.style { background:#fce4ec; }
.energy { background:#ede7f6; }
.risk { background:#ffebee; text-align:center; }

.bar { height:8px; background:#ccc; border-radius:4px; overflow:hidden; }
.fill-trait { height:100%; background:#66bb6a; }
.fill-style { height:100%; background:#ec407a; }
.fill-energy { height:100%; background:#7e57c2; }

.low-confidence { opacity:.6; font-style:italic; }

.badge {
  display:inline-block;
  padding:3px 7px;
  border-radius:12px;
  font-size:11px;
  background:#607d8b;
  color:#fff;
  margin:2px 2px 0 0;
}

.trend-up { color:#2e7d32; }
.trend-down { color:#c62828; }
.trend-flat { color:#777; }

[data-tip] { position:relative; cursor:help; }
[data-tip]:hover::after {
  content:attr(data-tip);
  position:absolute;
  bottom:120%; left:50%; transform:translateX(-50%);
  background:#333; color:#fff;
  padding:6px 8px; border-radius:6px;
  font-size:12px; width:220px;
  white-space:normal; z-index:999;
}

/* Compare */
#comparePanel {
  display:none;
  margin-top:16px;
  background:#fff;
  border:2px solid #1976d2;
  padding:12px;
}
.compare-grid {
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
  gap:12px;
}
.card {
  border:1px solid #ddd;
  padding:10px;
  background:#fafafa;
}
.small { font-size:12px; color:#666; }

/* Weekly */
#weekly {
  margin-top:20px;
  background:#fff;
  padding:12px;
  border:1px solid #ddd;
}
</style>
</head>

<body>

<h1>üèÜ SL Social Experiment Leaderboard</h1>

<div class="controls">
  <input id="search" placeholder="Search avatar‚Ä¶">

  <select id="mode">
    <option value="overall">Overall</option>
    <option value="engaging">Engaging</option>
    <option value="curious">Curious</option>
    <option value="humorous">Humorous</option>
    <option value="supportive">Supportive</option>
    <option value="dominant">Dominant</option>
    <option value="combative">Combative</option>
    <option value="flirty">Flirty</option>
    <option value="club_energy">Club Energy</option>
    <option value="hangout_energy">Hangout Energy</option>
    <option value="risk">Risk</option>
    <option value="confidence">Confidence</option>
  </select>

  <button id="compareBtn">Compare</button>
  <button id="clearBtn">Clear</button>
</div>

<table>
<thead>
<tr>
  <th class="sticky rank">#</th>
  <th class="sticky check">‚úì</th>
  <th class="sticky name">Name</th>

  <th class="meta">Confidence</th>
  <th class="meta">Vibe</th>
  <th class="summary">Summary</th>

  <th class="trait">Engaging</th>
  <th class="trait">Curious</th>
  <th class="trait">Humorous</th>
  <th class="trait">Supportive</th>
  <th class="trait">Dominant</th>
  <th class="trait">Combative</th>

  <th class="style">Flirty</th>
  <th class="style">Sexual</th>
  <th class="style">Curse</th>

  <th class="energy">Club</th>
  <th class="energy">Hangout</th>
  <th class="risk">Risk</th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>

<div id="comparePanel">
  <h2>üîç Compare Avatars</h2>
  <div class="compare-grid" id="compareGrid"></div>
</div>

<div id="weekly">
  <h2>üèÖ Weekly Standouts</h2>
  <div id="weeklyContent"></div>
</div>

<script>
const API = "https://sl-gpt-relay.onrender.com/leaderboard";
let DATA=[], MODE="overall", COMPARE=false;
let SELECTED=new Set();

const SNAP_KEY="sl_trend_snapshot";

fetch(API).then(r=>r.json()).then(d=>{
  DATA=d;
  applyTrends();
  render();
  renderWeekly();
  saveSnapshot();
});

search.oninput=render;
mode.onchange=e=>{ MODE=e.target.value; render(); };

compareBtn.onclick=()=>{
  COMPARE=!COMPARE;
  compareBtn.classList.toggle("active",COMPARE);
  comparePanel.style.display=COMPARE?"block":"none";
  render();
};

clearBtn.onclick=()=>{
  SELECTED.clear();
  render();
};

function score(p,mode){
  if(p.traits?.[mode]!=null) return p.traits[mode];
  if(p.styles?.[mode]!=null) return p.styles[mode];
  if(p[mode]!=null) return p[mode];
  return 0;
}

function bar(v,cls){
  v=Math.round(v||0);
  return `<div class="bar"><div class="${cls}" style="width:${v}%"></div></div>${v}%`;
}

function trendIcon(v){
  if(v>1) return `<span class="trend-up">‚¨Ü</span>`;
  if(v<-1) return `<span class="trend-down">‚¨á</span>`;
  return `<span class="trend-flat">‚Üí</span>`;
}

function render(){
  let q=search.value.toLowerCase();
  let list=DATA.filter(p=>p.name.toLowerCase().includes(q));

  if(MODE!=="overall"){
    list.sort((a,b)=>score(b,MODE)-score(a,MODE));
  }

  rows.innerHTML="";
  list.forEach((p,i)=>{
    let t=p.traits||{}, s=p.styles||{};
    let fade=p.confidence<25?"low-confidence":"";
    let vibe=p.vibe+(p.live?` ¬∑ ${p.live}`:"");

    rows.innerHTML+=`
<tr class="${fade}">
<td class="sticky rank">${i+1}</td>
<td class="sticky check">
<input type="checkbox"
${SELECTED.has(p.name)?"checked":""}
${SELECTED.size>=4&&!SELECTED.has(p.name)?"disabled":""}
onchange="toggleSelect('${p.name}')">
</td>
<td class="sticky name">${p.name}</td>

<td class="meta">${p.confidence}%</td>
<td class="meta">${vibe}</td>

<td class="summary">
${p.summary}
<div>${(p.badges||[]).map(b=>`<span class="badge">${b}</span>`).join("")}</div>
</td>

<td class="trait">${bar(t.engaging,"fill-trait")} ${trendIcon(p.trends?.engaging)}</td>
<td class="trait">${bar(t.curious,"fill-trait")} ${trendIcon(p.trends?.curious)}</td>
<td class="trait">${bar(t.humorous,"fill-trait")} ${trendIcon(p.trends?.humorous)}</td>
<td class="trait">${bar(t.supportive,"fill-trait")} ${trendIcon(p.trends?.supportive)}</td>
<td class="trait">${bar(t.dominant,"fill-trait")} ${trendIcon(p.trends?.dominant)}</td>
<td class="trait">${bar(t.combative,"fill-trait")} ${trendIcon(p.trends?.combative)}</td>

<td class="style">${bar(s.flirty,"fill-style")}</td>
<td class="style">${bar(s.sexual,"fill-style")}</td>
<td class="style">${bar(s.curse,"fill-style")}</td>

<td class="energy">${bar(p.club_energy,"fill-energy")}</td>
<td class="energy">${bar(p.hangout_energy,"fill-energy")}</td>
<td class="risk">${p.risk}</td>
</tr>`;
  });

  renderCompare();
}

function toggleSelect(n){
  if(SELECTED.has(n)) SELECTED.delete(n);
  else if(SELECTED.size<4) SELECTED.add(n);
  render();
}

function renderCompare(){
  if(!COMPARE){
    compareGrid.innerHTML="<div class='small'>Select up to 4 avatars to compare.</div>";
    return;
  }
  compareGrid.innerHTML="";
  DATA.filter(p=>SELECTED.has(p.name)).forEach(p=>{
    compareGrid.innerHTML+=`
<div class="card">
<h3>${p.name}</h3>
<div class="small">${p.summary}</div>
<div><b>Vibe:</b> ${p.vibe}</div>
<div><b>Risk:</b> ${p.risk}</div>
</div>`;
  });
}

function renderWeekly(){
  const top=t=>DATA.reduce((a,b)=>b.traits[t]>a.traits[t]?b:a);
  weeklyContent.innerHTML=`
üé§ Funniest: <b>${top("humorous").name}</b><br>
ü´Ç Comfort Avatar: <b>${top("supportive").name}</b><br>
üé≠ Social Magnet: <b>${top("engaging").name}</b>
`;
}

function saveSnapshot(){
  let snap={};
  DATA.forEach(p=>snap[p.name]=p.traits);
  localStorage.setItem(SNAP_KEY,JSON.stringify(snap));
}

function applyTrends(){
  let prev=JSON.parse(localStorage.getItem(SNAP_KEY)||"{}");
  DATA.forEach(p=>{
    p.trends={};
    let old=prev[p.name]||{};
    for(let k in p.traits){
      p.trends[k]=(p.traits[k]||0)-(old[k]||0);
    }
  });
}
</script>

</body>
</html>
